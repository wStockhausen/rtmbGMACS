#--set up environment----
CODE
  require(Matrix);
  require(reformulas);
  require(rtmbGMACS);
  dirPrj = rstudioapi::getActiveProject();
END_CODE
#--set up rtmbGMACS model dimensions----
CODE
  source(file.path(dirPrj,"testing/newTest_FilesCTL-Allometry/r01_SetupDims.R"));
END_CODE

#--rtmbGMACS allometry specifications----
PROCESS_ALLOMETRY
  #--OPTIONS
  # pwrLaw1: w(z|pA,pB)       = pA*z^pB
  # pwrLaw2: w(z|pLnA,pB,pZ0) = exp(pLnA+pB*log(z/pZ0))
  #--parameter relationships:
  ##--pLnA = log(pA)  + pB*log(pZ0)
  ##--pA   = exp(pLnA - pB*log(pZ0))
  CODE
    ###--probably don't need to keep original sparse indices with any derived model frames
    mfYXM  = dmsYSC |> dplyr::select(sp_idx=sparse_idx,y,x,m) |> dplyr::distinct() |>
                dplyr::mutate(yn=as.numeric(y),
                              yblk=ifelse(yn<2019,"<2019",
                                          ifelse(yn<2022,"<2022",">=2022")));
    contr_none  = "contr.none";
    contr_sum   = list(x="contr.sum",m="contr.sum");
  END_CODE
  PARAM_EQS
    par_id  par_idx   frame  link_fcn  formaula             contrasts    rePDF
    pLnA       1      mfYXM   ident    ~0+x:m+diag(1|y)     contr_none   normal  #--fixed effects: sex x maturity state, REs: intercept by year
    pB         1      mfYXM   ident    ~0+x:m               contr_none   NA      #
    pZ0        1      mfYXM   ident    ~0+x:m               contr_none   NA
  END_PARAM_EQS
  FUNCTIONS
  fcn_idx  fcn_id      fcn_nm    frame    vars  par_idxs                fcnREsEQ  fcnREsCovType fcnREsVarEQ fcnREsPDF fcnREsLink  description
    1      males       pwrLaw2   mfYXPx    z    c(pLnA=1,pB=1,pZ0=1)    NA        NA            NA           NA        NA          males:_w(z)_=_exp(pLnA+pB*log(z/pZ0))
    2      females     pwrLaw2   mfYXMf    z    c(pLnA=2,pB=2,pZ0=1)    NA        NA            NA           NA        NA          females:_w(z)_=_exp(pLnA+pB*log(z/pZ0))
  END_FUNCTIONS
#  FUNCTIONS_REs
#  #--type: "RE" or "VAR"
#  fcn_idx  fcn_id  type  {factors/covariates} mirror  phase  IV  LB  UB
#  END_FUNCTIONS_REs
END_ALLOMETRY
